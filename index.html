<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoldMinning - Gold Mining Game</title>
    <style>
        :root {
            --primary: #000000;
            --accent: #FFD700;
            --secondary-gradient: linear-gradient(90deg, #C5A100, #FFD700);
            --background: #121212;
            --text: #FFFFFF;
            --card-bg: #1a1a1a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .container {
            width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Auth Styles - Android Optimized */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--background);
            padding: 20px;
        }
        
        .auth-box {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 100%;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .auth-tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s;
            font-size: 18px;
        }
        
        .auth-tab.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .form-control {
            width: 100%;
            padding: 16px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text);
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        
        .btn {
            padding: 18px 25px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            font-size: 18px;
            min-height: 60px;
        }
        
        .btn-primary {
            background: var(--secondary-gradient);
            color: var(--primary);
            width: 100%;
        }
        
        .btn-primary:hover, .btn-primary:active {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 14px 20px;
            min-height: 50px;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: rgba(255, 215, 0, 0.1);
        }
        
        /* Dashboard Styles - Android Optimized */
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background-color: var(--primary);
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
        }
        
        .logo span {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .balance-display {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .user-rank {
            color: #3498db;
            font-weight: 600;
            font-size: 14px;
        }
        
        .announcement-icon {
            cursor: pointer;
            font-size: 22px;
            position: relative;
            padding: 8px;
        }
        
        .announcement-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-content {
            padding: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .mining-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .mining-zone {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: 
                radial-gradient(circle at 30% 20%, #87CEEB 0%, transparent 30%),
                radial-gradient(circle at 70% 25%, #87CEEB 0%, transparent 25%),
                radial-gradient(circle at 50% 80%, #2E8B57 0%, #228B22 30%, #006400 70%, transparent 100%);
            border: 3px solid var(--accent);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
            touch-action: manipulation;
            overflow: hidden;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); }
        }
        
        /* Nature Elements */
        .sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to bottom, #87CEEB, #B0E2FF);
            border-radius: 50% 50% 0 0;
            z-index: 1;
        }
        
        .grass {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(to top, #2E8B57, #228B22, #006400);
            border-radius: 0 0 50% 50%;
            z-index: 1;
        }
        
        .plant {
            position: absolute;
            z-index: 2;
        }
        
        .plant-1 {
            bottom: 30%;
            left: 20%;
            width: 25px;
            height: 40px;
            background: 
                linear-gradient(to right, #32CD32, #228B22);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: rotate(-5deg);
        }
        
        .plant-2 {
            bottom: 25%;
            right: 25%;
            width: 20px;
            height: 35px;
            background: 
                linear-gradient(to right, #32CD32, #228B22);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: rotate(10deg);
        }
        
        .plant-3 {
            bottom: 35%;
            left: 60%;
            width: 30px;
            height: 50px;
            background: 
                linear-gradient(to right, #32CD32, #228B22);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: rotate(-15deg);
        }
        
        .plant-4 {
            bottom: 28%;
            right: 15%;
            width: 22px;
            height: 38px;
            background: 
                linear-gradient(to right, #32CD32, #228B22);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: rotate(5deg);
        }
        
        .plant-5 {
            bottom: 32%;
            left: 40%;
            width: 18px;
            height: 32px;
            background: 
                linear-gradient(to right, #32CD32, #228B22);
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            transform: rotate(-8deg);
        }
        
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            z-index: 2;
        }
        
        .cloud-1 {
            top: 15%;
            left: 20%;
            width: 40px;
            height: 25px;
            opacity: 0.8;
        }
        
        .cloud-2 {
            top: 25%;
            right: 25%;
            width: 35px;
            height: 20px;
            opacity: 0.7;
        }
        
        .cloud-3 {
            top: 10%;
            right: 15%;
            width: 30px;
            height: 18px;
            opacity: 0.9;
        }
        
        .cobra-container {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3;
        }
        
        .cobra-snake {
            width: 150px;
            height: 150px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,20 C60,10 80,15 80,30 C80,45 65,50 50,50 C35,50 20,45 20,30 C20,15 40,10 50,20 Z" fill="%23C5A100" stroke="%23FFD700" stroke-width="2"/><circle cx="40" cy="30" r="5" fill="%23000"/><circle cx="60" cy="30" r="5" fill="%23000"/><path d="M45,40 Q50,45 55,40" stroke="%23000" stroke-width="2" fill="none"/><path d="M50,50 C40,60 30,70 40,80 C50,90 60,85 60,75 C60,65 50,60 50,50 Z" fill="%23C5A100" stroke="%23FFD700" stroke-width="2"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: cobraMove 3s infinite alternate;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
        }
        
        @keyframes cobraMove {
            0% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-5px) rotate(0deg); }
            100% { transform: translateY(0) rotate(5deg); }
        }
        
        .gold-pile {
            position: absolute;
            bottom: 30px;
            width: 70px;
            height: 40px;
            background: var(--secondary-gradient);
            border-radius: 10px 10px 5px 5px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4;
        }
        
        .gold-pile::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            top: 4px;
        }
        
        .gold-pile::after {
            content: "💰";
            font-size: 20px;
            position: relative;
            z-index: 5;
        }
        
        .tap-instruction {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            text-align: center;
        }
        
        .auto-mining-section {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .auto-mining-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .auto-mining-header h3 {
            font-size: 18px;
            color: var(--accent);
        }
        
        .auto-mining-toggle {
            position: relative;
            display: inline-block;
            width: 65px;
            height: 38px;
        }
        
        .auto-mining-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 38px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: var(--secondary-gradient);
        }
        
        input:checked + .slider:before {
            transform: translateX(27px);
        }
        
        .timer-bar {
            height: 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .timer-progress {
            height: 100%;
            background: var(--secondary-gradient);
            width: 0%;
            transition: width 1s linear;
        }
        
        .timer-text {
            text-align: center;
            margin-top: 12px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .feature-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .feature-card h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .referral-code {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: monospace;
            text-align: center;
            border: 1px dashed rgba(255, 215, 0, 0.5);
            font-size: 16px;
            word-break: break-all;
        }
        
        .footer {
            background-color: var(--primary);
            padding: 20px 0;
            text-align: center;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
            margin-top: 30px;
        }
        
        .footer p {
            color: var(--accent);
            font-size: 16px;
            border-bottom: 1px solid var(--accent);
            display: inline-block;
            padding-bottom: 5px;
        }
        
        /* Modal Styles - Android Optimized */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 22px;
            color: var(--accent);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text);
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
        }
        
        .terms-content {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 20px;
        }
        
        .terms-content p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .agree-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .agree-checkbox input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        
        /* Announcements Styles */
        .announcement-item {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        
        .announcement-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 16px;
        }
        
        .announcement-date {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .announcement-content {
            line-height: 1.5;
            font-size: 16px;
        }
        
        .no-announcements {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
        }
        
        /* --- START: Gems & Staking Feature Styles --- */
        .balance-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .gems-display {
            font-size: 16px;
            font-weight: 600;
            color: #FF69B4;
            text-shadow: 0 0 10px rgba(255, 105, 180, 0.5);
        }
        
        .staking-item {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #FF69B4;
        }
        
        .staking-amount {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .staking-countdown {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .no-staking {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
        }
        
        .gem-animation {
            position: fixed;
            font-size: 24px;
            z-index: 10000;
            pointer-events: none;
            animation: gemFloat 2s ease-out forwards;
        }
        
        @keyframes gemFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }
        /* --- END: Gems & Staking Feature Styles --- */

        /* Success Message Styles */
        .success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-gradient);
            color: var(--primary);
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        /* --- START: ENHANCED ADMIN PANEL STYLES --- */
        .admin-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .admin-section h3 {
            font-size: 18px;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }

        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s;
            font-size: 16px;
        }

        .admin-tab.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        .admin-panel-content {
            display: none;
        }

        .admin-panel-content.active {
            display: block;
        }

        .users-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .user-item {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info-small {
            flex: 1;
        }

        .user-email {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .user-actions button {
            padding: 8px 12px;
            font-size: 14px;
            min-height: auto;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }

        /* --- END: ENHANCED ADMIN PANEL STYLES --- */

        /* --- START: 3D ANIMATION STYLES --- */
        .animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 2s ease-in-out 3s forwards;
        }

        .goldmining-text {
            font-size: 48px;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.4);
            animation: 
                pulseText 1.5s ease-in-out infinite alternate,
                rotate3d 4s ease-in-out infinite;
            transform-style: preserve-3d;
        }

        @keyframes pulseText {
            from {
                transform: scale(1);
                text-shadow: 
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.4);
            }
            to {
                transform: scale(1.1);
                text-shadow: 
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 25px rgba(255, 215, 0, 0.8),
                    0 0 35px rgba(255, 215, 0, 0.6);
            }
        }

        @keyframes rotate3d {
            0% {
                transform: perspective(1000px) rotateY(0deg);
            }
            25% {
                transform: perspective(1000px) rotateY(15deg);
            }
            50% {
                transform: perspective(1000px) rotateY(0deg);
            }
            75% {
                transform: perspective(1000px) rotateY(-15deg);
            }
            100% {
                transform: perspective(1000px) rotateY(0deg);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                visibility: hidden;
            }
        }
        /* --- END: 3D ANIMATION STYLES --- */
        
        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .auth-box {
                padding: 20px;
            }
            
            .auth-tab {
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .btn {
                padding: 16px 20px;
                font-size: 16px;
                min-height: 55px;
            }
            
            .mining-zone {
                width: 250px;
                height: 250px;
            }
            
            .cobra-container {
                width: 160px;
                height: 160px;
            }
            
            .cobra-snake {
                width: 130px;
                height: 130px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 22px;
            }
            
            .feature-card {
                padding: 15px;
            }
            
            .modal-content {
                padding: 20px;
            }

            .success-message {
                padding: 12px 20px;
                font-size: 14px;
            }

            .goldmining-text {
                font-size: 36px;
            }

            .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .user-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media (max-width: 360px) {
            .mining-zone {
                width: 220px;
                height: 220px;
            }
            
            .cobra-container {
                width: 140px;
                height: 140px;
            }
            
            .cobra-snake {
                width: 110px;
                height: 110px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .balance-display {
                font-size: 16px;
            }

            .goldmining-text {
                font-size: 28px;
            }
        }
        
        /* Prevent zoom on input focus for iOS */
        @media screen and (max-width: 767px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- 3D Animation Container -->
    <div id="animationContainer" class="animation-container">
        <div class="goldmining-text">GoldMinning</div>
    </div>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-container">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Sign In</div>
                <div class="auth-tab" id="signupTab">Create Account</div>
            </div>
            
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginReferral">Referral Code (Optional)</label>
                    <input type="text" id="loginReferral" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
            
            <form id="signupForm" class="auth-form">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupPhone">Phone Number</label>
                    <input type="tel" id="signupPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupReferral">Referral Code (Optional)</label>
                    <input type="text" id="signupReferral" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
            
            <div id="authMessage" style="margin-top: 15px; text-align: center; color: #ff6b6b; display: none; font-size: 16px;"></div>
        </div>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span>🏆</span> GoldMinning
                    </div>
                    <div class="user-info">
                        <!-- --- START: Gems & Staking Feature - Updated Balance Display --- -->
                        <div class="balance-container">
                            <div class="balance-display" id="balanceDisplay">0 Coins</div>
                            <div class="gems-display" id="gemsDisplay">💎 0 Gems</div>
                        </div>
                        <!-- --- END: Gems & Staking Feature - Updated Balance Display --- -->
                        <div class="user-rank" id="userRank">Rank 1</div>
                        <button class="refresh-btn" id="refreshBtn" title="Refresh Balance">🔄</button>
                        <div class="announcement-icon" id="announcementIcon">
                            📢
                            <div class="announcement-badge" id="announcementBadge" style="display: none;">0</div>
                        </div>
                        <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="main-content">
            <div class="container">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Balance</h3>
                        <!-- --- START: Gems & Staking Feature - Updated Total Balance --- -->
                        <div class="stat-value">
                            <div id="totalBalance">0 Coins</div>
                            <div id="totalGems">💎 0 Gems</div>
                        </div>
                        <!-- --- END: Gems & Staking Feature - Updated Total Balance --- -->
                    </div>
                    <div class="stat-card">
                        <h3>Referrals</h3>
                        <div class="stat-value" id="referralCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Auto Mining</h3>
                        <div class="stat-value" id="autoMiningStatus">Inactive</div>
                    </div>
                </div>
                
                <div class="mining-area">
                    <div class="mining-zone" id="miningZone">
                        <!-- Sky and Nature Background -->
                        <div class="sky"></div>
                        <div class="grass"></div>
                        
                        <!-- Plants -->
                        <div class="plant plant-1"></div>
                        <div class="plant plant-2"></div>
                        <div class="plant plant-3"></div>
                        <div class="plant plant-4"></div>
                        <div class="plant plant-5"></div>
                        
                        <!-- Clouds -->
                        <div class="cloud cloud-1"></div>
                        <div class="cloud cloud-2"></div>
                        <div class="cloud cloud-3"></div>
                        
                        <!-- Cobra and Gold Pile -->
                        <div class="cobra-container">
                            <div class="cobra-snake"></div>
                            <div class="gold-pile"></div>
                        </div>
                    </div>
                    <div class="tap-instruction">Tap the gold pile to mine coins!</div>
                </div>
                
                <div class="auto-mining-section">
                    <div class="auto-mining-header">
                        <h3>Auto Mining</h3>
                        <label class="auto-mining-toggle">
                            <input type="checkbox" id="autoMiningToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="timer-bar">
                        <div class="timer-progress" id="timerProgress"></div>
                    </div>
                    <div class="timer-text" id="timerText">Auto Mining: Inactive</div>
                </div>
                
                <div class="features-grid">
                    <!-- --- START: Gems & Staking Feature - New Staking Card --- -->
                    <div class="feature-card">
                        <h3>💎 Stake Coins</h3>
                        <p>Stake your coins to earn gems! 2000 coins = 1 gem after 3 days.</p>
                        <button class="btn btn-primary" id="stakeCoinsBtn">Stake Coins</button>
                    </div>
                    
                    <div class="feature-card">
                        <h3>⏳ Active Staking</h3>
                        <div id="activeStakingList">
                            <div class="no-staking">No active staking</div>
                        </div>
                    </div>
                    <!-- --- END: Gems & Staking Feature - New Staking Card --- -->
                    
                    <div class="feature-card">
                        <h3>👥 Referral System</h3>
                        <p>Invite friends and earn rewards!</p>
                        <div class="referral-code" id="referralCode">Loading...</div>
                        <p>Share this code with friends when they sign up</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3>💰 Deposit</h3>
                        <p>To deposit, contact your Assistant Mining Agent.</p>
                        <button class="btn btn-primary" style="margin-top: 15px;">Contact Agent</button>
                    </div>
                    
                    <div class="feature-card">
                        <h3>💸 Withdrawal</h3>
                        <p>Withdrawals will open once the coin price is officially announced.</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" disabled>Withdraw Locked</button>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <div class="container">
                <p>Powered by | GoldMinning</p>
            </div>
        </footer>
    </div>
    
    <!-- Terms & Conditions Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📜 Terms & Conditions</h2>
                <button class="close-modal" id="closeTermsModal">&times;</button>
            </div>
            <div class="terms-content">
                <p>This is a skill-based mining game.</p>
                <p>Users earn coins by manual tapping or auto-mining.</p>
                <p>Deposit $1 to unlock mining access until the coin price is announced.</p>
                <p>The coin price will be revealed between 0.00003 and 0.7 USD.</p>
                <p>Users may gain profit or face partial loss based on the final price.</p>
                <p>Coins represent your in-game effort, not a guaranteed return.</p>
                <p>Each user can have only one account per Gmail and phone number.</p>
                <p>Auto-mining runs for 2 hours and must be restarted after time ends.</p>
                <p>Withdrawals will open once the coin price is officially declared.</p>
                <p>Deposit section shows contact details of Assistant Mining Agents.</p>
                <p>Referrals help users grow faster and unlock rewards.</p>
                <p>Reaching Senior Assistant Level gives a chance to earn $200/month. But confirmed by company you will receive a mail as confirmation.</p>
                <p>To qualify, complete 30 referrals in 1 week, 90 in 3 weeks, and 2 daily afterward.</p>
                <p>Any use of auto-tapping or cheating tools will lead to permanent account ban.</p>
                <p>By clicking or playing, you are accepting our Terms & Conditions and agree to follow all game rules.</p>
            </div>
            <div class="agree-checkbox">
                <input type="checkbox" id="agreeCheckbox">
                <label for="agreeCheckbox">I agree to the Terms & Conditions</label>
            </div>
            <button class="btn btn-primary" id="agreeButton" disabled>I Agree</button>
        </div>
    </div>
    
    <!-- Announcements Modal -->
    <div id="announcementsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📢 Announcements</h2>
                <button class="close-modal" id="closeAnnouncementsModal">&times;</button>
            </div>
            <div id="announcementsList">
                <!-- Announcements will be dynamically added here -->
                <div class="no-announcements">No announcements available</div>
            </div>
        </div>
    </div>
    
    <!-- --- START: Gems & Staking Feature - Staking Modal --- -->
    <div id="stakingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💎 Stake Coins</h2>
                <button class="close-modal" id="closeStakingModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="stakeAmount">Amount to Stake (minimum 2000 coins)</label>
                <input type="number" id="stakeAmount" class="form-control" min="2000" step="1" value="2000">
                <div style="margin-top: 10px; color: rgba(255,255,255,0.7);">
                    You will receive: <span id="gemsToReceive">1</span> 💎
                </div>
            </div>
            <button class="btn btn-primary" id="confirmStakeBtn">Stake Now</button>
        </div>
    </div>
    <!-- --- END: Gems & Staking Feature - Staking Modal --- -->

    <!-- --- START: ENHANCED ADMIN PANEL --- -->
    <div id="adminPanel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔧 Admin Panel</h2>
                <button class="close-modal" id="closeAdminModal">&times;</button>
            </div>
            
            <div class="admin-tabs">
                <div class="admin-tab active" id="announcementsTab">Announcements</div>
                <div class="admin-tab" id="usersTab">Manage Users</div>
                <div class="admin-tab" id="personalTab">Personal Messages</div>
            </div>
            
            <!-- Announcements Tab -->
            <div id="announcementsContent" class="admin-panel-content active">
                <div class="admin-section">
                    <h3>📢 Send Announcement</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="announcementTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="announcementContent" class="form-control" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" id="sendAnnouncementBtn">Send Announcement</button>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="usersContent" class="admin-panel-content">
                <div class="admin-section">
                    <h3>👥 Manage Users</h3>
                    <button class="btn btn-secondary" id="loadUsersBtn">Load All Users</button>
                    <div class="users-list" id="usersList">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3>👤 Manage Specific User</h3>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="userIdForRank" class="form-control" placeholder="Enter user UID">
                    </div>
                    <div class="form-group">
                        <label>New Rank (1-4)</label>
                        <select id="newUserRank" class="form-control">
                            <option value="1">Rank 1 - Beginner</option>
                            <option value="2">Rank 2 - Intermediate</option>
                            <option value="3">Rank 3 - Advanced</option>
                            <option value="4">Rank 4 - Expert</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="updateRankBtn">Update Rank</button>
                </div>
                
                <div class="admin-section">
                    <h3>💰 Manage User Balance</h3>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="userIdForBalance" class="form-control" placeholder="Enter user UID">
                    </div>
                    <div class="form-group">
                        <label>New Balance</label>
                        <input type="number" id="newUserBalance" class="form-control" min="0">
                    </div>
                    <button class="btn btn-primary" id="updateBalanceBtn">Update Balance</button>
                </div>
            </div>
            
            <!-- Personal Messages Tab -->
            <div id="personalContent" class="admin-panel-content">
                <div class="admin-section">
                    <h3>📩 Send Personal Message</h3>
                    <div class="form-group">
                        <label>Select User</label>
                        <select id="personalMessageUser" class="form-control">
                            <option value="all">All Users</option>
                            <!-- Users will be populated here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="personalMessageTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="personalMessageContent" class="form-control" rows="4"></textarea>
                    </div>
                    <button class="btn btn-primary" id="sendPersonalMessageBtn">Send Message</button>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-secondary" id="closeAdminPanelBtn">Close Admin Panel</button>
            </div>
        </div>
    </div>
    <!-- --- END: ENHANCED ADMIN PANEL --- -->
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxkcz5xCEIBnvPkLdQf_7aKcIPFNsf3u0",
            authDomain: "goldmining-7f702.firebaseapp.com",
            projectId: "goldmining-7f702",
            storageBucket: "goldmining-7f702.firebasestorage.app",
            messagingSenderId: "631626307433",
            appId: "1:631626307433:web:81c8e4c05f70a399e8cff8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseFirestore = db;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            orderBy,
            addDoc,
            serverTimestamp,
            where,
            getDocs
        };
    </script>
    
    <!-- Game Logic -->
    <script>
        // DOM Elements
        const authSection = document.getElementById('authSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const authMessage = document.getElementById('authMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const balanceDisplay = document.getElementById('balanceDisplay');
        const totalBalance = document.getElementById('totalBalance');
        const miningZone = document.getElementById('miningZone');
        const autoMiningToggle = document.getElementById('autoMiningToggle');
        const timerProgress = document.getElementById('timerProgress');
        const timerText = document.getElementById('timerText');
        const referralCount = document.getElementById('referralCount');
        const referralCode = document.getElementById('referralCode');
        const userRank = document.getElementById('userRank');
        const announcementIcon = document.getElementById('announcementIcon');
        const announcementBadge = document.getElementById('announcementBadge');
        const termsModal = document.getElementById('termsModal');
        const closeTermsModal = document.getElementById('closeTermsModal');
        const agreeCheckbox = document.getElementById('agreeCheckbox');
        const agreeButton = document.getElementById('agreeButton');
        const announcementsModal = document.getElementById('announcementsModal');
        const closeAnnouncementsModal = document.getElementById('closeAnnouncementsModal');
        const announcementsList = document.getElementById('announcementsList');
        
        // --- START: Gems & Staking Feature - New DOM Elements ---
        const gemsDisplay = document.getElementById('gemsDisplay');
        const totalGems = document.getElementById('totalGems');
        const stakeCoinsBtn = document.getElementById('stakeCoinsBtn');
        const stakingModal = document.getElementById('stakingModal');
        const closeStakingModal = document.getElementById('closeStakingModal');
        const stakeAmount = document.getElementById('stakeAmount');
        const gemsToReceive = document.getElementById('gemsToReceive');
        const confirmStakeBtn = document.getElementById('confirmStakeBtn');
        const activeStakingList = document.getElementById('activeStakingList');
        // --- END: Gems & Staking Feature - New DOM Elements ---

        // --- START: ENHANCED ADMIN PANEL ELEMENTS ---
        const adminPanel = document.getElementById('adminPanel');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const sendAnnouncementBtn = document.getElementById('sendAnnouncementBtn');
        const updateRankBtn = document.getElementById('updateRankBtn');
        const updateBalanceBtn = document.getElementById('updateBalanceBtn');
        const closeAdminPanelBtn = document.getElementById('closeAdminPanelBtn');
        const loadUsersBtn = document.getElementById('loadUsersBtn');
        const usersList = document.getElementById('usersList');
        const sendPersonalMessageBtn = document.getElementById('sendPersonalMessageBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        // --- END: ENHANCED ADMIN PANEL ELEMENTS ---
        
        // --- START: ADMIN TABS ---
        const announcementsTab = document.getElementById('announcementsTab');
        const usersTab = document.getElementById('usersTab');
        const personalTab = document.getElementById('personalTab');
        const announcementsContent = document.getElementById('announcementsContent');
        const usersContent = document.getElementById('usersContent');
        const personalContent = document.getElementById('personalContent');
        // --- END: ADMIN TABS ---
        
        // Game State
        let userData = {
            uid: null,
            email: null,
            phone: null,
            balance: 0,
            coins: 0,
            referrals: 0,
            role: 'user',
            rank: 1,
            lastLogin: null,
            autoMiningEnd: null,
            agreedToTerms: false,
            lastSeenAnnouncement: null
        };
        
        let autoMiningInterval = null;
        let autoMiningTimeLeft = 0;
        let autoMiningTotalTime = 2 * 60 * 60; // 2 hours in seconds
        let announcements = [];
        let unreadAnnouncementsCount = 0;
        
        // --- START: Gems & Staking Feature - New Game State ---
        let gems = 0;
        let activeStakes = [];
        let stakingCheckInterval = null;
        // --- END: Gems & Staking Feature - New Game State ---
        
        // Auth Tab Switching
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
            authMessage.style.display = 'none';
        });
        
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
            authMessage.style.display = 'none';
        });
        
        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const userCredential = await window.firebaseFunctions.signInWithEmailAndPassword(
                    window.firebaseAuth, email, password
                );
                const user = userCredential.user;
                
                // Show success message
                showSuccessMessage('Login successful!');
                
                // Load user data from Firestore
                await loadUserData(user.uid);
                
            } catch (error) {
                showAuthMessage(error.message);
            }
        });
        
        // Signup Form Submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const phone = document.getElementById('signupPhone').value;
            const referral = document.getElementById('signupReferral').value;
            
            try {
                const userCredential = await window.firebaseFunctions.createUserWithEmailAndPassword(
                    window.firebaseAuth, email, password
                );
                const user = userCredential.user;
                
                // Show success message
                showSuccessMessage('Account created successfully!');
                
                // Create user data in Firestore - FIXED: Use setDoc instead of updateDoc for initial creation
                const userDataToSave = {
                    uid: user.uid,
                    email: email,
                    phone: phone,
                    balance: 0,
                    coins: 0,
                    referrals: 0,
                    role: 'user',
                    rank: 1,
                    lastLogin: new Date().toISOString(),
                    autoMiningEnd: null,
                    agreedToTerms: false,
                    lastSeenAnnouncement: null,
                    // --- START: Gems & Staking Feature - Add gems to user data ---
                    gems: 0
                    // --- END: Gems & Staking Feature - Add gems to user data ---
                };
                
                await window.firebaseFunctions.setDoc(
                    window.firebaseFunctions.doc(window.firebaseFirestore, "users", user.uid),
                    userDataToSave
                );
                
                // Set the userData object
                userData = userDataToSave;
                
                // Handle referral if provided
                if (referral) {
                    await handleReferral(referral, user.uid);
                }
                
                // Show terms modal
                showTermsModal();
                
            } catch (error) {
                showAuthMessage(error.message);
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await window.firebaseFunctions.signOut(window.firebaseAuth);
                showAuth();
                resetGameState();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
        
        // Mining Zone Click
        miningZone.addEventListener('click', (e) => {
            if (!userData.uid) return;
            
            // Update balance - ONE TAP = ONE COIN ONLY
            userData.balance += 1;
            userData.coins += 1;
            
            // Update display
            updateBalanceDisplay();
            
            // Save to Firestore
            saveUserData();
            
            // Show +1 animation
            showPlusOneAnimation(e);
            
            // Play sparkle effect
            playSparkleEffect();
        });
        
        // Auto Mining Toggle
        autoMiningToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                startAutoMining();
            } else {
                stopAutoMining();
            }
        });
        
        // Terms Modal
        agreeCheckbox.addEventListener('change', (e) => {
            agreeButton.disabled = !e.target.checked;
        });
        
        agreeButton.addEventListener('click', () => {
            userData.agreedToTerms = true;
            saveUserData();
            hideTermsModal();
        });
        
        closeTermsModal.addEventListener('click', hideTermsModal);
        
        // Announcements
        announcementIcon.addEventListener('click', () => {
            showAnnouncementsModal();
        });
        
        closeAnnouncementsModal.addEventListener('click', hideAnnouncementsModal);
        
        // --- START: Gems & Staking Feature - Event Listeners ---
        stakeCoinsBtn.addEventListener('click', () => {
            showStakingModal();
        });
        
        closeStakingModal.addEventListener('click', hideStakingModal);
        
        stakeAmount.addEventListener('input', (e) => {
            const amount = parseInt(e.target.value) || 0;
            const gems = Math.floor(amount / 2000);
            gemsToReceive.textContent = gems;
        });
        
        confirmStakeBtn.addEventListener('click', async () => {
            await createStaking();
        });
        // --- END: Gems & Staking Feature - Event Listeners ---

        // --- START: ENHANCED ADMIN PANEL EVENT LISTENERS ---
        closeAdminModal.addEventListener('click', hideAdminPanel);
        closeAdminPanelBtn.addEventListener('click', hideAdminPanel);
        sendAnnouncementBtn.addEventListener('click', sendAnnouncement);
        updateRankBtn.addEventListener('click', updateUserRank);
        updateBalanceBtn.addEventListener('click', updateUserBalance);
        loadUsersBtn.addEventListener('click', loadAllUsers);
        sendPersonalMessageBtn.addEventListener('click', sendPersonalMessage);
        refreshBtn.addEventListener('click', refreshBalance);
        
        // Admin Tabs
        announcementsTab.addEventListener('click', () => {
            setActiveAdminTab('announcements');
        });
        
        usersTab.addEventListener('click', () => {
            setActiveAdminTab('users');
        });
        
        personalTab.addEventListener('click', () => {
            setActiveAdminTab('personal');
        });
        // --- END: ENHANCED ADMIN PANEL EVENT LISTENERS ---
        
        // Functions
        function showAuthMessage(message) {
            authMessage.textContent = message;
            authMessage.style.display = 'block';
        }

        function showSuccessMessage(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = message;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 2000);
        }
        
        function showAuth() {
            authSection.style.display = 'flex';
            dashboardSection.style.display = 'none';
        }
        
        function showDashboard() {
            authSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            updateBalanceDisplay();
            updateReferralDisplay();
            
            // Check if auto mining is active
            if (userData.autoMiningEnd) {
                const endTime = new Date(userData.autoMiningEnd).getTime();
                const now = new Date().getTime();
                
                if (endTime > now) {
                    autoMiningTimeLeft = Math.floor((endTime - now) / 1000);
                    startAutoMining();
                } else {
                    // Auto mining has ended
                    userData.autoMiningEnd = null;
                    saveUserData();
                }
            }
            
            // Load announcements
            loadAnnouncements();
            
            // --- START: Gems & Staking Feature - Load staking data ---
            loadStakingRecords();
            startStakingCheckInterval();
            // --- END: Gems & Staking Feature - Load staking data ---

            // Add admin button if user is admin
            addAdminButton();
        }
        
        async function loadUserData(uid) {
            try {
                const docRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", uid);
                const docSnap = await window.firebaseFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userData = data;
                    userData.uid = uid;
                    
                    // --- START: Gems & Staking Feature - Load gems ---
                    gems = data.gems || 0;
                    // --- END: Gems & Staking Feature - Load gems ---
                    
                    // Update last login
                    userData.lastLogin = new Date().toISOString();
                    await saveUserData();
                    
                    // Show dashboard after loading user data
                    showDashboard();
                    
                    // Set up real-time listener for user data
                    window.firebaseFunctions.onSnapshot(docRef, (doc) => {
                        if (doc.exists()) {
                            const updatedData = doc.data();
                            userData.balance = updatedData.balance;
                            userData.coins = updatedData.coins;
                            userData.referrals = updatedData.referrals;
                            userData.rank = updatedData.rank || 1;
                            // --- START: Gems & Staking Feature - Update gems ---
                            gems = updatedData.gems || 0;
                            // --- END: Gems & Staking Feature - Update gems ---
                            updateBalanceDisplay();
                            updateReferralDisplay();
                            updateRankDisplay();
                        }
                    });
                    
                    // Show terms modal if user hasn't agreed yet
                    if (!userData.agreedToTerms) {
                        showTermsModal();
                    }
                } else {
                    // User document doesn't exist - create it
                    await createUserDocument(uid);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showAuthMessage('Error loading user data. Please try again.');
            }
        }
        
        async function createUserDocument(uid) {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;
                
                const userDataToSave = {
                    uid: uid,
                    email: user.email,
                    phone: '',
                    balance: 0,
                    coins: 0,
                    referrals: 0,
                    role: 'user',
                    rank: 1,
                    lastLogin: new Date().toISOString(),
                    autoMiningEnd: null,
                    agreedToTerms: false,
                    lastSeenAnnouncement: null,
                    // --- START: Gems & Staking Feature - Add gems to new user ---
                    gems: 0
                    // --- END: Gems & Staking Feature - Add gems to new user ---
                };
                
                await window.firebaseFunctions.setDoc(
                    window.firebaseFunctions.doc(window.firebaseFirestore, "users", uid),
                    userDataToSave
                );
                
                userData = userDataToSave;
                showDashboard();
                showTermsModal();
            } catch (error) {
                console.error('Error creating user document:', error);
                showAuthMessage('Error creating user profile. Please try again.');
            }
        }
        
        async function saveUserData() {
            if (!userData.uid) return;
            
            try {
                const docRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", userData.uid);
                await window.firebaseFunctions.updateDoc(docRef, {
                    ...userData,
                    // --- START: Gems & Staking Feature - Save gems ---
                    gems: gems
                    // --- END: Gems & Staking Feature - Save gems ---
                });
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }
        
        function updateBalanceDisplay() {
            // Format balance to 2 decimal places
            const formattedBalance = parseFloat(userData.balance).toFixed(2);
            balanceDisplay.textContent = `${formattedBalance} Coins`;
            totalBalance.textContent = `${formattedBalance} Coins`;
            // --- START: Gems & Staking Feature - Update gems display ---
            gemsDisplay.textContent = `💎 ${gems} Gems`;
            totalGems.textContent = `💎 ${gems} Gems`;
            // --- END: Gems & Staking Feature - Update gems display ---
        }
        
        function updateReferralDisplay() {
            referralCount.textContent = userData.referrals;
            referralCode.textContent = userData.uid || 'Loading...';
        }
        
        function updateRankDisplay() {
            userRank.textContent = `Rank ${userData.rank || 1}`;
        }
        
        function showPlusOneAnimation(e) {
            const plusOne = document.createElement('span');
            plusOne.innerText = '+1';
            plusOne.style.position = 'absolute';
            plusOne.style.left = e.pageX - 10 + 'px';
            plusOne.style.top = e.pageY - 20 + 'px';
            plusOne.style.color = '#FFD700';
            plusOne.style.fontWeight = 'bold';
            plusOne.style.fontSize = '18px';
            plusOne.style.opacity = '1';
            plusOne.style.transition = 'all 0.8s ease-out';
            plusOne.style.zIndex = '1000';
            plusOne.style.pointerEvents = 'none';
            
            document.body.appendChild(plusOne);
            
            setTimeout(() => {
                plusOne.style.top = (e.pageY - 60) + 'px';
                plusOne.style.opacity = '0';
            }, 100);
            
            setTimeout(() => {
                plusOne.remove();
            }, 900);
        }
        
        function playSparkleEffect() {
            const goldPile = document.querySelector('.gold-pile');
            goldPile.style.boxShadow = '0 0 30px rgba(255, 215, 0, 1)';
            
            setTimeout(() => {
                goldPile.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.7)';
            }, 300);
        }
        
        function startAutoMining() {
            autoMiningToggle.checked = true;
            
            // Set auto mining end time if not already set
            if (!userData.autoMiningEnd) {
                const endTime = new Date();
                endTime.setHours(endTime.getHours() + 2);
                userData.autoMiningEnd = endTime.toISOString();
                autoMiningTimeLeft = autoMiningTotalTime;
                saveUserData();
            } else {
                // Calculate time left from stored end time
                const endTime = new Date(userData.autoMiningEnd).getTime();
                const now = new Date().getTime();
                autoMiningTimeLeft = Math.floor((endTime - now) / 1000);
            }
            
            // Update auto mining status display
            document.getElementById('autoMiningStatus').textContent = 'Active';
            
            // Start the interval
            if (autoMiningInterval) clearInterval(autoMiningInterval);
            
            autoMiningInterval = setInterval(() => {
                if (autoMiningTimeLeft <= 0) {
                    stopAutoMining();
                    return;
                }
                
                // Add coins every second
                userData.balance += 0.1;
                userData.coins += 0.1;
                
                // Update display
                updateBalanceDisplay();
                
                // Update timer
                autoMiningTimeLeft--;
                updateAutoMiningTimer();
                
                // Save every 30 seconds
                if (autoMiningTimeLeft % 30 === 0) {
                    saveUserData();
                }
                
            }, 1000);
            
            updateAutoMiningTimer();
        }
        
        function stopAutoMining() {
            autoMiningToggle.checked = false;
            
            if (autoMiningInterval) {
                clearInterval(autoMiningInterval);
                autoMiningInterval = null;
            }
            
            userData.autoMiningEnd = null;
            saveUserData();
            
            timerProgress.style.width = '0%';
            timerText.textContent = 'Auto Mining: Inactive';
            document.getElementById('autoMiningStatus').textContent = 'Inactive';
        }
        
        function updateAutoMiningTimer() {
            const percentage = ((autoMiningTotalTime - autoMiningTimeLeft) / autoMiningTotalTime) * 100;
            timerProgress.style.width = `${percentage}%`;
            
            const hours = Math.floor(autoMiningTimeLeft / 3600);
            const minutes = Math.floor((autoMiningTimeLeft % 3600) / 60);
            const seconds = autoMiningTimeLeft % 60;
            
            timerText.textContent = `Auto Mining: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function showTermsModal() {
            termsModal.style.display = 'flex';
        }
        
        function hideTermsModal() {
            termsModal.style.display = 'none';
        }
        
        function showAnnouncementsModal() {
            announcementsModal.style.display = 'flex';
            // Mark announcements as seen
            markAnnouncementsAsSeen();
        }
        
        function hideAnnouncementsModal() {
            announcementsModal.style.display = 'none';
        }
        
        function resetGameState() {
            userData = {
                uid: null,
                email: null,
                phone: null,
                balance: 0,
                coins: 0,
                referrals: 0,
                role: 'user',
                rank: 1,
                lastLogin: null,
                autoMiningEnd: null,
                agreedToTerms: false,
                lastSeenAnnouncement: null
            };
            
            // --- START: Gems & Staking Feature - Reset gems and staking ---
            gems = 0;
            activeStakes = [];
            if (stakingCheckInterval) {
                clearInterval(stakingCheckInterval);
                stakingCheckInterval = null;
            }
            // --- END: Gems & Staking Feature - Reset gems and staking ---
            
            if (autoMiningInterval) {
                clearInterval(autoMiningInterval);
                autoMiningInterval = null;
            }
            
            autoMiningTimeLeft = 0;
            timerProgress.style.width = '0%';
            timerText.textContent = 'Auto Mining: Inactive';
        }
        
        async function handleReferral(referralCode, newUserId) {
            try {
                // Find the user with this referral code
                const docRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", referralCode);
                const docSnap = await window.firebaseFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const referrerData = docSnap.data();
                    
                    // Update referrer's referral count
                    await window.firebaseFunctions.updateDoc(docRef, {
                        referrals: referrerData.referrals + 1
                    });
                    
                    // Give bonus to new user
                    userData.balance += 10;
                    userData.coins += 10;
                    updateBalanceDisplay();
                    saveUserData();
                }
            } catch (error) {
                console.error('Error handling referral:', error);
            }
        }
        
        // Announcements Functions
        async function loadAnnouncements() {
            try {
                const announcementsRef = window.firebaseFunctions.collection(window.firebaseFirestore, "announcements");
                const q = window.firebaseFunctions.query(announcementsRef, window.firebaseFunctions.orderBy("timestamp", "desc"));
                
                window.firebaseFunctions.onSnapshot(q, (querySnapshot) => {
                    announcements = [];
                    querySnapshot.forEach((doc) => {
                        announcements.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    renderAnnouncements();
                    updateUnreadAnnouncementsCount();
                });
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }
        
        function renderAnnouncements() {
            announcementsList.innerHTML = '';
            
            if (announcements.length === 0) {
                announcementsList.innerHTML = '<div class="no-announcements">No announcements available</div>';
                return;
            }
            
            announcements.forEach(announcement => {
                const announcementItem = document.createElement('div');
                announcementItem.className = 'announcement-item';
                
                const announcementDate = new Date(announcement.timestamp?.toDate() || new Date()).toLocaleDateString();
                
                announcementItem.innerHTML = `
                    <div class="announcement-title">
                        <span>${announcement.title || 'Announcement'}</span>
                        <span class="announcement-date">${announcementDate}</span>
                    </div>
                    <div class="announcement-content">${announcement.content || ''}</div>
                `;
                
                announcementsList.appendChild(announcementItem);
            });
        }
        
        function updateUnreadAnnouncementsCount() {
            if (!userData.lastSeenAnnouncement || announcements.length === 0) {
                unreadAnnouncementsCount = announcements.length;
            } else {
                // Find the index of the last seen announcement
                const lastSeenIndex = announcements.findIndex(a => a.id === userData.lastSeenAnnouncement);
                unreadAnnouncementsCount = lastSeenIndex === -1 ? announcements.length : announcements.length - (lastSeenIndex + 1);
            }
            
            if (unreadAnnouncementsCount > 0) {
                announcementBadge.textContent = unreadAnnouncementsCount;
                announcementBadge.style.display = 'flex';
            } else {
                announcementBadge.style.display = 'none';
            }
        }
        
        function markAnnouncementsAsSeen() {
            if (announcements.length > 0) {
                userData.lastSeenAnnouncement = announcements[0].id;
                saveUserData();
                unreadAnnouncementsCount = 0;
                announcementBadge.style.display = 'none';
            }
        }
        
        // --- START: Gems & Staking Feature - New Functions ---
        function showStakingModal() {
            stakingModal.style.display = 'flex';
            // Reset stake amount to minimum
            stakeAmount.value = 2000;
            gemsToReceive.textContent = 1;
        }
        
        function hideStakingModal() {
            stakingModal.style.display = 'none';
        }
        
        async function createStaking() {
            const amount = parseInt(stakeAmount.value);
            
            // Validation
            if (amount < 2000) {
                alert('Minimum staking amount is 2000 coins');
                return;
            }
            
            if (amount > userData.balance) {
                alert('You do not have enough coins');
                return;
            }
            
            if (amount % 2000 !== 0) {
                alert('Amount must be in multiples of 2000 coins');
                return;
            }
            
            try {
                // Deduct coins from balance
                userData.balance -= amount;
                updateBalanceDisplay();
                
                // Create staking record
                const stakingRef = window.firebaseFunctions.collection(
                    window.firebaseFirestore, 
                    "users", 
                    userData.uid, 
                    "staking"
                );
                
                const startTime = new Date();
                const endTime = new Date(startTime.getTime() + 3 * 24 * 60 * 60 * 1000); // 3 days
                const gemsToEarn = amount / 2000;
                
                const stakingRecord = {
                    amount: amount,
                    startTime: startTime.toISOString(),
                    endTime: endTime.toISOString(),
                    status: "active",
                    convertedGems: gemsToEarn
                };
                
                await window.firebaseFunctions.addDoc(stakingRef, stakingRecord);
                
                // Save user data
                await saveUserData();
                
                // Hide modal and show success
                hideStakingModal();
                alert(`Successfully staked ${amount} coins! You will receive ${gemsToEarn} gems in 3 days.`);
                
                // Reload staking records
                loadStakingRecords();
                
            } catch (error) {
                console.error('Error creating staking:', error);
                alert('Error creating staking. Please try again.');
                // Refund coins if error
                userData.balance += amount;
                updateBalanceDisplay();
            }
        }
        
        async function loadStakingRecords() {
            if (!userData.uid) return;
            
            try {
                const stakingRef = window.firebaseFunctions.collection(
                    window.firebaseFirestore, 
                    "users", 
                    userData.uid, 
                    "staking"
                );
                const q = window.firebaseFunctions.query(
                    stakingRef, 
                    window.firebaseFunctions.where("status", "==", "active")
                );
                
                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                activeStakes = [];
                
                querySnapshot.forEach((doc) => {
                    activeStakes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderActiveStakes();
                
            } catch (error) {
                console.error('Error loading staking records:', error);
            }
        }
        
        function renderActiveStakes() {
            activeStakingList.innerHTML = '';
            
            if (activeStakes.length === 0) {
                activeStakingList.innerHTML = '<div class="no-staking">No active staking</div>';
                return;
            }
            
            activeStakes.forEach(stake => {
                const stakeItem = document.createElement('div');
                stakeItem.className = 'staking-item';
                
                const endTime = new Date(stake.endTime);
                const now = new Date();
                const timeLeft = endTime - now;
                
                let timeText = "Completed!";
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timeText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                }
                
                stakeItem.innerHTML = `
                    <div class="staking-amount">${stake.amount} Coins → ${stake.convertedGems} Gems</div>
                    <div class="staking-countdown">Ends in: ${timeText}</div>
                `;
                
                activeStakingList.appendChild(stakeItem);
            });
        }
        
        async function checkAndCompleteStakes() {
            if (!userData.uid || activeStakes.length === 0) return;
            
            const now = new Date();
            let updated = false;
            
            for (const stake of activeStakes) {
                const endTime = new Date(stake.endTime);
                
                if (endTime <= now && stake.status === "active") {
                    // Complete this stake
                    try {
                        const stakeRef = window.firebaseFunctions.doc(
                            window.firebaseFirestore, 
                            "users", 
                            userData.uid, 
                            "staking", 
                            stake.id
                        );
                        
                        // Update stake status
                        await window.firebaseFunctions.updateDoc(stakeRef, {
                            status: "completed"
                        });
                        
                        // Add gems to user
                        gems += stake.convertedGems;
                        updateBalanceDisplay();
                        
                        // Save user data
                        await saveUserData();
                        
                        // Show gem animation
                        showGemAnimation(stake.convertedGems);
                        
                        updated = true;
                        
                    } catch (error) {
                        console.error('Error completing stake:', error);
                    }
                }
            }
            
            if (updated) {
                // Reload staking records
                loadStakingRecords();
            }
        }
        
        function startStakingCheckInterval() {
            // Check every 10 seconds for completed stakes
            stakingCheckInterval = setInterval(() => {
                checkAndCompleteStakes();
                renderActiveStakes(); // Update countdown display
            }, 10000);
        }
        
        function showGemAnimation(gemCount) {
            for (let i = 0; i < Math.min(gemCount, 10); i++) {
                setTimeout(() => {
                    const gem = document.createElement('div');
                    gem.className = 'gem-animation';
                    gem.innerHTML = '💎';
                    gem.style.left = Math.random() * 80 + 10 + '%';
                    gem.style.top = '80%';
                    
                    document.body.appendChild(gem);
                    
                    setTimeout(() => {
                        gem.remove();
                    }, 2000);
                }, i * 200);
            }
            
            // Show notification
            setTimeout(() => {
                alert(`🎉 You received ${gemCount} gems from staking!`);
            }, 500);
        }
        // --- END: Gems & Staking Feature - New Functions ---

        // --- START: ENHANCED ADMIN PANEL FUNCTIONS ---
        function showAdminPanel() {
            if (isAdminUser()) {
                adminPanel.style.display = 'flex';
                // Load users for personal messages dropdown
                loadUsersForDropdown();
            } else {
                alert('Access denied. Admin privileges required.');
            }
        }
        
        function hideAdminPanel() {
            adminPanel.style.display = 'none';
        }
        
        function setActiveAdminTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-panel-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to selected tab and content
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.getElementById(`${tabName}Content`).classList.add('active');
        }
        
        function isAdminUser() {
            const adminEmails = ['cptanil1995@gmail.com', 'auk5562@gmail.com', 'kafe2999@gmail.com'];
            return userData && adminEmails.includes(userData.email);
        }
        
        function addAdminButton() {
            if (isAdminUser()) {
                // Check if admin button already exists
                if (!document.getElementById('adminBtn')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.id = 'adminBtn';
                    adminBtn.className = 'btn btn-secondary';
                    adminBtn.innerHTML = '🔧 Admin';
                    adminBtn.onclick = showAdminPanel;
                    adminBtn.style.marginLeft = '10px';
                    
                    document.querySelector('.user-info').appendChild(adminBtn);
                }
            }
        }
        
        async function sendAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }
            
            try {
                const announcementsRef = window.firebaseFunctions.collection(window.firebaseFirestore, "announcements");
                await window.firebaseFunctions.addDoc(announcementsRef, {
                    title: title,
                    content: content,
                    timestamp: window.firebaseFunctions.serverTimestamp(),
                    createdBy: userData.uid
                });
                
                alert('Announcement sent successfully!');
                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementContent').value = '';
            } catch (error) {
                console.error('Error sending announcement:', error);
                alert('Error sending announcement: ' + error.message);
            }
        }
        
        async function updateUserRank() {
            const userId = document.getElementById('userIdForRank').value;
            const newRank = document.getElementById('newUserRank').value;
            
            if (!userId) {
                alert('Please enter a user ID');
                return;
            }
            
            try {
                const userRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", userId);
                await window.firebaseFunctions.updateDoc(userRef, {
                    rank: parseInt(newRank)
                });
                
                alert(`User rank updated to ${newRank} successfully!`);
                document.getElementById('userIdForRank').value = '';
            } catch (error) {
                console.error('Error updating user rank:', error);
                alert('Error updating user rank: ' + error.message);
            }
        }
        
        async function updateUserBalance() {
            const userId = document.getElementById('userIdForBalance').value;
            const newBalance = parseInt(document.getElementById('newUserBalance').value);
            
            if (!userId || isNaN(newBalance)) {
                alert('Please enter valid user ID and balance');
                return;
            }
            
            try {
                const userRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", userId);
                await window.firebaseFunctions.updateDoc(userRef, {
                    balance: newBalance,
                    coins: newBalance
                });
                
                alert(`User balance updated to ${newBalance} successfully!`);
                document.getElementById('userIdForBalance').value = '';
                document.getElementById('newUserBalance').value = '';
            } catch (error) {
                console.error('Error updating user balance:', error);
                alert('Error updating user balance: ' + error.message);
            }
        }
        
        async function loadAllUsers() {
            try {
                const usersRef = window.firebaseFunctions.collection(window.firebaseFirestore, "users");
                const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                
                usersList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    usersList.innerHTML = '<div class="no-announcements">No users found</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    userItem.innerHTML = `
                        <div class="user-info-small">
                            <div class="user-email">${user.email}</div>
                            <div class="user-stats">
                                <span>Rank: ${user.rank || 1}</span>
                                <span>Balance: ${parseFloat(user.balance || 0).toFixed(2)}</span>
                                <span>Gems: ${user.gems || 0}</span>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-secondary" onclick="promptUpdateRank('${doc.id}')">Update Rank</button>
                            <button class="btn btn-secondary" onclick="promptUpdateBalance('${doc.id}')">Update Balance</button>
                        </div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
                
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users: ' + error.message);
            }
        }
        
        async function loadUsersForDropdown() {
            try {
                const usersRef = window.firebaseFunctions.collection(window.firebaseFirestore, "users");
                const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                
                const dropdown = document.getElementById('personalMessageUser');
                // Clear existing options except "All Users"
                while (dropdown.children.length > 1) {
                    dropdown.removeChild(dropdown.lastChild);
                }
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = user.email;
                    dropdown.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading users for dropdown:', error);
            }
        }
        
        async function sendPersonalMessage() {
            const userId = document.getElementById('personalMessageUser').value;
            const title = document.getElementById('personalMessageTitle').value;
            const content = document.getElementById('personalMessageContent').value;
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }
            
            try {
                const personalMessagesRef = window.firebaseFunctions.collection(window.firebaseFirestore, "personalMessages");
                
                if (userId === 'all') {
                    // Send to all users
                    const usersRef = window.firebaseFunctions.collection(window.firebaseFirestore, "users");
                    const querySnapshot = await window.firebaseFunctions.getDocs(usersRef);
                    
                    const promises = [];
                    querySnapshot.forEach((doc) => {
                        const promise = window.firebaseFunctions.addDoc(personalMessagesRef, {
                            userId: doc.id,
                            title: title,
                            content: content,
                            timestamp: window.firebaseFunctions.serverTimestamp(),
                            sentBy: userData.uid,
                            isRead: false
                        });
                        promises.push(promise);
                    });
                    
                    await Promise.all(promises);
                    alert('Personal message sent to all users successfully!');
                } else {
                    // Send to specific user
                    await window.firebaseFunctions.addDoc(personalMessagesRef, {
                        userId: userId,
                        title: title,
                        content: content,
                        timestamp: window.firebaseFunctions.serverTimestamp(),
                        sentBy: userData.uid,
                        isRead: false
                    });
                    
                    alert('Personal message sent successfully!');
                }
                
                document.getElementById('personalMessageTitle').value = '';
                document.getElementById('personalMessageContent').value = '';
                
            } catch (error) {
                console.error('Error sending personal message:', error);
                alert('Error sending personal message: ' + error.message);
            }
        }
        
        function refreshBalance() {
            // Add a spinning animation to the refresh button
            const refreshIcon = refreshBtn.querySelector('span') || refreshBtn;
            refreshIcon.style.animation = 'spin 1s linear';
            
            setTimeout(() => {
                refreshIcon.style.animation = '';
            }, 1000);
            
            // Force update the balance display
            updateBalanceDisplay();
            
            // Show success message
            showSuccessMessage('Balance refreshed!');
        }
        
        // Global functions for user actions
        window.promptUpdateRank = function(userId) {
            const newRank = prompt('Enter new rank (1-4):');
            if (newRank && newRank >= 1 && newRank <= 4) {
                updateSpecificUserRank(userId, parseInt(newRank));
            } else {
                alert('Invalid rank. Please enter a number between 1 and 4.');
            }
        };
        
        window.promptUpdateBalance = function(userId) {
            const newBalance = prompt('Enter new balance:');
            if (newBalance && !isNaN(newBalance)) {
                updateSpecificUserBalance(userId, parseFloat(newBalance));
            } else {
                alert('Invalid balance. Please enter a valid number.');
            }
        };
        
        async function updateSpecificUserRank(userId, newRank) {
            try {
                const userRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", userId);
                await window.firebaseFunctions.updateDoc(userRef, {
                    rank: newRank
                });
                
                alert(`User rank updated to ${newRank} successfully!`);
                // Reload users list
                loadAllUsers();
            } catch (error) {
                console.error('Error updating user rank:', error);
                alert('Error updating user rank: ' + error.message);
            }
        }
        
        async function updateSpecificUserBalance(userId, newBalance) {
            try {
                const userRef = window.firebaseFunctions.doc(window.firebaseFirestore, "users", userId);
                await window.firebaseFunctions.updateDoc(userRef, {
                    balance: newBalance,
                    coins: newBalance
                });
                
                alert(`User balance updated to ${newBalance} successfully!`);
                // Reload users list
                loadAllUsers();
            } catch (error) {
                console.error('Error updating user balance:', error);
                alert('Error updating user balance: ' + error.message);
            }
        }
        // --- END: ENHANCED ADMIN PANEL FUNCTIONS ---
        
        // Initialize
        showAuth();
        
        // Check if user is already logged in
        window.firebaseFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
            if (user) {
                // User is signed in
                loadUserData(user.uid);
            } else {
                // User is signed out
                showAuth();
            }
        });
        
        // Hide 3D animation after 3 seconds
        setTimeout(() => {
            document.getElementById('animationContainer').style.display = 'none';
        }, 3000);
        
        // For testing: Add sample announcements (remove in production)
        setTimeout(async () => {
            // Only add sample announcements if none exist
            try {
                const announcementsRef = window.firebaseFunctions.collection(window.firebaseFirestore, "announcements");
                const q = window.firebaseFunctions.query(announcementsRef);
                const querySnapshot = await window.firebaseFunctions.getDocs(q);
                
                if (querySnapshot.empty) {
                    // Add sample announcements
                    const sampleAnnouncements = [
                        {
                            title: "Welcome to GoldMinning!",
                            content: "We're excited to have you on board. Start mining coins and invite friends to earn bonuses!",
                            timestamp: window.firebaseFunctions.serverTimestamp()
                        },
                        {
                            title: "Auto Mining Feature",
                            content: "Remember to activate Auto Mining to earn coins even when you're not actively playing!",
                            timestamp: window.firebaseFunctions.serverTimestamp()
                        },
                        {
                            title: "Referral Bonus Increased",
                            content: "We've increased the referral bonus to 10 coins for each friend who signs up using your code!",
                            timestamp: window.firebaseFunctions.serverTimestamp()
                        }
                    ];
                    
                    for (const announcement of sampleAnnouncements) {
                        await window.firebaseFunctions.addDoc(announcementsRef, announcement);
                    }
                }
            } catch (error) {
                console.error('Error adding sample announcements:', error);
            }
        }, 2000);
    </script>
</body>
</html>
